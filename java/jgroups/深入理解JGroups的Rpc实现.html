<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解JGroups的Rpc实现 | Jinze Song&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <meta name="description" content="持续学习，持续进步">
    
    <link rel="preload" href="/assets/css/0.styles.d6ad21ed.css" as="style"><link rel="preload" href="/assets/js/app.bdbeba68.js" as="script"><link rel="preload" href="/assets/js/2.327ce0e8.js" as="script"><link rel="preload" href="/assets/js/39.37c8c86a.js" as="script"><link rel="prefetch" href="/assets/js/10.e80513bd.js"><link rel="prefetch" href="/assets/js/11.7212d24b.js"><link rel="prefetch" href="/assets/js/12.c0b00be2.js"><link rel="prefetch" href="/assets/js/13.cbe3c690.js"><link rel="prefetch" href="/assets/js/14.ca75ee06.js"><link rel="prefetch" href="/assets/js/15.b6f52780.js"><link rel="prefetch" href="/assets/js/16.4a0150c3.js"><link rel="prefetch" href="/assets/js/17.e49c1b6a.js"><link rel="prefetch" href="/assets/js/18.29fb44a7.js"><link rel="prefetch" href="/assets/js/19.e78bb553.js"><link rel="prefetch" href="/assets/js/20.9185eec5.js"><link rel="prefetch" href="/assets/js/21.d5f93b02.js"><link rel="prefetch" href="/assets/js/22.4adc221c.js"><link rel="prefetch" href="/assets/js/23.e850e1d2.js"><link rel="prefetch" href="/assets/js/24.6ba02d21.js"><link rel="prefetch" href="/assets/js/25.77d5f493.js"><link rel="prefetch" href="/assets/js/26.d96a16dc.js"><link rel="prefetch" href="/assets/js/27.cfeebd57.js"><link rel="prefetch" href="/assets/js/28.5baa9dde.js"><link rel="prefetch" href="/assets/js/29.97b6145b.js"><link rel="prefetch" href="/assets/js/3.62ca7b57.js"><link rel="prefetch" href="/assets/js/30.728c7236.js"><link rel="prefetch" href="/assets/js/31.301d8afa.js"><link rel="prefetch" href="/assets/js/32.904f563f.js"><link rel="prefetch" href="/assets/js/33.96f615d7.js"><link rel="prefetch" href="/assets/js/34.f89323e6.js"><link rel="prefetch" href="/assets/js/35.14246a58.js"><link rel="prefetch" href="/assets/js/36.33daeddb.js"><link rel="prefetch" href="/assets/js/37.0102d792.js"><link rel="prefetch" href="/assets/js/38.d2ef212b.js"><link rel="prefetch" href="/assets/js/4.308078f6.js"><link rel="prefetch" href="/assets/js/40.c74c1a0f.js"><link rel="prefetch" href="/assets/js/41.f7187f97.js"><link rel="prefetch" href="/assets/js/42.bf1d8fc1.js"><link rel="prefetch" href="/assets/js/43.8c735bbe.js"><link rel="prefetch" href="/assets/js/44.2cf77552.js"><link rel="prefetch" href="/assets/js/45.26c1f27d.js"><link rel="prefetch" href="/assets/js/46.a39f5cb0.js"><link rel="prefetch" href="/assets/js/47.a99dda1e.js"><link rel="prefetch" href="/assets/js/48.182032fb.js"><link rel="prefetch" href="/assets/js/49.101aff25.js"><link rel="prefetch" href="/assets/js/5.8d00347e.js"><link rel="prefetch" href="/assets/js/50.05e874a0.js"><link rel="prefetch" href="/assets/js/51.5d20d392.js"><link rel="prefetch" href="/assets/js/52.a87b9d1c.js"><link rel="prefetch" href="/assets/js/53.5944507a.js"><link rel="prefetch" href="/assets/js/6.b41f3d08.js"><link rel="prefetch" href="/assets/js/7.67d9facb.js"><link rel="prefetch" href="/assets/js/8.642af7a3.js"><link rel="prefetch" href="/assets/js/9.d74fcfcb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6ad21ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jinze Song's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/architecture/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/songjinze" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/architecture/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/songjinze" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/java/jgroups/" aria-current="page" class="sidebar-link">JGroups源码学习</a></li><li><a href="/java/jgroups/初探JGroup.html" class="sidebar-link">初探JGroups</a></li><li><a href="/java/jgroups/JChannel初探.html" class="sidebar-link">JChannel初探</a></li><li><a href="/java/jgroups/深入理解JChannel.html" class="sidebar-link">深入理解JChannel</a></li><li><a href="/java/jgroups/Building Blocks使用.html" class="sidebar-link">Building Blocks使用</a></li><li><a href="/java/jgroups/深入理解JGroups的Rpc实现.html" class="active sidebar-link">深入理解JGroups的Rpc实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/jgroups/深入理解JGroups的Rpc实现.html#从building-blocks开始" class="sidebar-link">从Building Blocks开始</a></li><li class="sidebar-sub-header"><a href="/java/jgroups/深入理解JGroups的Rpc实现.html#rpc在消息之上需要做的事情" class="sidebar-link">Rpc在消息之上需要做的事情</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深入理解jgroups的rpc实现"><a href="#深入理解jgroups的rpc实现" class="header-anchor">#</a> 深入理解JGroups的Rpc实现</h1> <h2 id="从building-blocks开始"><a href="#从building-blocks开始" class="header-anchor">#</a> 从Building Blocks开始</h2> <p>Building Blocks是针对JChannel的更上层抽象。以JChannel之上扩展出的不同BuildingBlocks实现，可以开发出基于网络传输的多种功能。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JChannel</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">UpHandler</span>                             up_handler<span class="token punctuation">;</span> 
    <span class="token keyword">protected</span> <span class="token class-name">Receiver</span>                              receiver<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JChannel</span>      <span class="token function">setReceiver</span><span class="token punctuation">(</span><span class="token class-name">Receiver</span> r<span class="token punctuation">)</span>             <span class="token punctuation">{</span>receiver<span class="token operator">=</span>r<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">UpHandler</span>     <span class="token function">getUpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                      <span class="token punctuation">{</span><span class="token keyword">return</span> up_handler<span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            received_msgs<span class="token operator">++</span><span class="token punctuation">;</span>
            received_bytes<span class="token operator">+=</span>msg<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// discard local messages (sent by myself to me)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>discard_own_messages <span class="token operator">&amp;&amp;</span> local_addr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">getSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> local_addr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// If UpHandler is installed, pass all events to it and return (UpHandler is e.g. a building block)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>up_handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> up_handler<span class="token punctuation">.</span><span class="token function">up</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>receiver <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            receiver<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpHandler</span> <span class="token punctuation">{</span>
   
   <span class="token comment">/**
    * Invoked for all channel events except connection management and state transfer.
    */</span>
    <span class="token class-name">Object</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Event</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Object</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">MessageBatch</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token operator">:</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">up</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>从JChannel的up方法可以看出，如果一个JChannel注册了UpHandler，那么JChannel在获取到消息时便会跳过Receiver。所以当使用BuildingBlocks，可以认为是将UpHandler认为是真正的消息处理者，而JChannel变成了一个中间者。</p> <h3 id="包装jchannel"><a href="#包装jchannel" class="header-anchor">#</a> 包装JChannel</h3> <p>使用RpcDispatcher时发现RpcDispatcher继承自MessageDispatcher。MessageDispatcher在创建时使用JChannel作为构造函数。在源码中可以看出其包装了一个新的Protocol，名为ProtocolAdapter，作为JChannel的UpHandler。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestHandler</span><span class="token punctuation">,</span> <span class="token class-name">Closeable</span><span class="token punctuation">,</span> <span class="token class-name">ChannelListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageDispatcher</span><span class="token punctuation">(</span><span class="token class-name">JChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token operator">=</span>channel<span class="token punctuation">;</span>
        prot_adapter<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ProtocolAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">addChannelListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            local_addr<span class="token operator">=</span>channel<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">installUpHandler</span><span class="token punctuation">(</span>prot_adapter<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span> <span class="token keyword">extends</span> <span class="token class-name">MessageDispatcher</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">X</span> <span class="token function">installUpHandler</span><span class="token punctuation">(</span><span class="token class-name">UpHandler</span> handler<span class="token punctuation">,</span> <span class="token keyword">boolean</span> canReplace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UpHandler</span> existing <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">getUpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            channel<span class="token punctuation">.</span><span class="token function">setUpHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>canReplace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Channel already has an up handler installed (%s) but now it is being overridden&quot;</span><span class="token punctuation">,</span> existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">setUpHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">X</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ProtocolAdapter其实没什么特别的，就是up和down方法。其中corr属性是用来处理Request和Response的封装方法类，具体做了什么事情在后文讲述。我们知道的是，一个消息从MessageDispatcher发出，和JChannel一样会先经过一个“协议栈”的链式结构到达最下端的发送者。不同的是MessageDispatcher是从ProtocolAdapter开始（也就是JChannel的UpHandler），经过JChannel，再到JChannel下层真正的协议栈。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ProtocolAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">Protocol</span> <span class="token keyword">implements</span> <span class="token class-name">UpHandler</span> <span class="token punctuation">{</span>


        <span class="token comment">/* ------------------------- Protocol Interface --------------------------- */</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;MessageDispatcher&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
         * Called by channel (we registered before) when event is received. This is the UpHandler interface.
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Event</span> evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>corr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>corr<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">handleUpEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>corr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                corr<span class="token punctuation">.</span><span class="token function">receiveMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">MessageBatch</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>corr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            corr<span class="token punctuation">.</span><span class="token function">receiveMessageBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token class-name">Event</span> evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">?</span> channel<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> channel<span class="token punctuation">.</span><span class="token function">isConnecting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// return null;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;channel is not connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> channel<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* ----------------------- End of Protocol Interface ------------------------ */</span>

    <span class="token punctuation">}</span>
</code></pre></div><h3 id="使用requestcorrelator发送requeqst和response"><a href="#使用requestcorrelator发送requeqst和response" class="header-anchor">#</a> 使用RequestCorrelator发送Requeqst和Response</h3> <p>到这里，我们可以看看RequestCorrelator真正做的是什么了。</p> <p>从MessageDispatcher的start()方法中可以看出，RequestCorrelator接收三个参数，Protocol（JChannel的UpHandler）、RequestHandler（也就是MessageDispatcher自己）、当前地址。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span> <span class="token keyword">extends</span> <span class="token class-name">MessageDispatcher</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">X</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>corr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            corr<span class="token operator">=</span><span class="token function">createRequestCorrelator</span><span class="token punctuation">(</span>prot_adapter<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> local_addr<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">asyncDispatching</span><span class="token punctuation">(</span>async_dispatching<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrapExceptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>wrap_exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">correlatorStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        corr<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> tmp_mbrs<span class="token operator">=</span>channel<span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> channel<span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token function">setMembers</span><span class="token punctuation">(</span>tmp_mbrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token keyword">instanceof</span> <span class="token class-name">JChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">TP</span> transport<span class="token operator">=</span>channel<span class="token punctuation">.</span><span class="token function">getProtocolStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                corr<span class="token punctuation">.</span><span class="token function">registerProbeHandler</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">X</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">RequestCorrelator</span> <span class="token function">createRequestCorrelator</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span> transport<span class="token punctuation">,</span> <span class="token class-name">RequestHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">Address</span> local_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestCorrelator</span><span class="token punctuation">(</span>transport<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>我们看一下一个消息在RequestCorrelator中会经历什么。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> dest_mbrs<span class="token punctuation">,</span> <span class="token class-name">Buffer</span> data<span class="token punctuation">,</span> <span class="token class-name">Request</span> req<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span> opts<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>transport <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;transport is not available !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// i.   Create the request correlator header and add it to the msg</span>
        <span class="token comment">// ii.  If a reply is expected (coll != null), add a coresponding entry in the pending requests table</span>
        <span class="token class-name">Header</span> hdr<span class="token operator">=</span>opts<span class="token punctuation">.</span><span class="token function">hasExclusionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">MultiDestinationHeader</span><span class="token punctuation">(</span><span class="token class-name">Header</span><span class="token punctuation">.</span><span class="token constant">REQ</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>corr_id<span class="token punctuation">,</span> opts<span class="token punctuation">.</span><span class="token function">exclusionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Header</span><span class="token punctuation">(</span><span class="token class-name">Header</span><span class="token punctuation">.</span><span class="token constant">REQ</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>corr_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Message</span> msg<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putHeader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>corr_id<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setFlag</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTransientFlag</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">transientFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>req <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sync</span>
            <span class="token keyword">long</span> req_id<span class="token operator">=</span><span class="token constant">REQUEST_ID</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            req<span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span>req_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hdr<span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span>req_id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set the request-id only for *synchronous RPCs*</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;%s: invoking multicast RPC [req-id=%d]&quot;</span><span class="token punctuation">,</span> local_addr<span class="token punctuation">,</span> req_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requests<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>req_id<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// make sure no view is received before we add ourself as a view handler (https://issues.jboss.org/browse/JGRP-1428)</span>
            req<span class="token punctuation">.</span><span class="token function">viewChange</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>rpc_stats<span class="token punctuation">.</span><span class="token function">extendedStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>start_time<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// async</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>opts <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span><span class="token function">anycasting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                rpc_stats<span class="token punctuation">.</span><span class="token function">addAnycast</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dest_mbrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                rpc_stats<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">RpcStats<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">MULTICAST</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">anycasting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">useAnycastAddresses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transport<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnycastAddress</span><span class="token punctuation">(</span>dest_mbrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> first<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Address</span> mbr<span class="token operator">:</span> dest_mbrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Message</span> copy<span class="token operator">=</span><span class="token punctuation">(</span>first<span class="token operator">?</span> msg <span class="token operator">:</span> msg<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>mbr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    first<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>mbr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>local_addr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> copy<span class="token punctuation">.</span><span class="token function">isTransientFlagSet</span><span class="token punctuation">(</span><span class="token class-name">Message<span class="token punctuation">.</span>TransientFlag</span><span class="token punctuation">.</span><span class="token constant">DONT_LOOPBACK</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        copy<span class="token punctuation">.</span><span class="token function">clearTransientFlag</span><span class="token punctuation">(</span><span class="token class-name">Message<span class="token punctuation">.</span>TransientFlag</span><span class="token punctuation">.</span><span class="token constant">DONT_LOOPBACK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    transport<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            transport<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>正如官方手册介绍的那样，一个数据消息会在原基础上添加Header头。其中包括消息类型、correlator_id，和一些其他选项。消息发送前根据异步还是同步发送，会先注册当前Request的信息到一个称为rpc_stats的管理器中。接下来最为关键的，使用transport.down(msg)发送。</p> <p>这里实现也比较粗糙，根据req是不是null来判断异步还是同步。实际上是因为只有Request创建后且为同步模式时，才会将Request作为参数放到方法中。下文会在Request.sendRequest中看到。</p> <h3 id="request的发送和接收"><a href="#request的发送和接收" class="header-anchor">#</a> Request的发送和接收</h3> <p>这里注意到方法参数Request，实际的请求封装正是此。Request实际上就是一个CompletableFuture。其sentRequest创建了发送请求，只有其receiverResponse被调用时，才会触发complete。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestCorrelator</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">Request</span> req<span class="token punctuation">,</span> <span class="token class-name">Address</span> sender<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">boolean</span> is_exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> retval<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            retval<span class="token operator">=</span><span class="token function">replyFromBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;FailedUnmarshallingBufferIntoReturnValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            retval<span class="token operator">=</span>e<span class="token punctuation">;</span>
            is_exception<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        req<span class="token punctuation">.</span><span class="token function">receiveResponse</span><span class="token punctuation">(</span>retval<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> is_exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>RequestCorrelator的handlerResponse比较简洁。下面是Request的相关方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Request</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span>       <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">Buffer</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span>       <span class="token function">receiveResponse</span><span class="token punctuation">(</span><span class="token class-name">Object</span> response_value<span class="token punctuation">,</span> <span class="token class-name">Address</span> sender<span class="token punctuation">,</span> <span class="token keyword">boolean</span> is_exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnicastRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Request</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">Buffer</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            corr<span class="token punctuation">.</span><span class="token function">sendUnicastRequest</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseMode</span><span class="token punctuation">.</span><span class="token constant">GET_NONE</span><span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">corrDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">/* ---------------------- Interface RspCollector -------------------------- */</span>
    <span class="token comment">/**
     * &lt;b&gt;Callback&lt;/b&gt; (called by RequestCorrelator or Transport).
     * Adds a response to the response table. When all responses have been received, {@code execute()} returns.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveResponse</span><span class="token punctuation">(</span><span class="token class-name">Object</span> response_value<span class="token punctuation">,</span> <span class="token class-name">Address</span> sender<span class="token punctuation">,</span> <span class="token keyword">boolean</span> is_exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>is_exception <span class="token operator">&amp;&amp;</span> response_value <span class="token keyword">instanceof</span> <span class="token class-name">Throwable</span><span class="token punctuation">)</span>
            <span class="token function">completeExceptionally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span>response_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>response_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">corrDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="rpc在消息之上需要做的事情"><a href="#rpc在消息之上需要做的事情" class="header-anchor">#</a> Rpc在消息之上需要做的事情</h2> <p>有了上面的基础，就完全明白了一个Building Blocks构造是怎么发送方法的。可以说Building Block在JChannel之上引入了异步和同步两个概念。这也为异步Rpc和同步Rpc打造了基础。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcDispatcher</span> <span class="token keyword">extends</span> <span class="token class-name">MessageDispatcher</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span>        server_obj<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">Marshaller</span>    marshaller<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">MethodLookup</span>  method_lookup<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">MethodInvoker</span> method_invoker<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>server_obj代表了当前Rpc调用的具体方法类。marshaller是针对request和response数据的自定义序列化方式，在下文会详细说明。method_lookup和method_invoker二者只有一个发挥作用。前者通过实现接口可以允许Rpc快速地查找到server_obj中的方法，而不必每次都重新获取class对象。method_invoker则更加直接，直接定义了invoke方法调用的逻辑。二者都是针对Rpc反射的效率优化。</p> <h3 id="发送方法调用调用remote"><a href="#发送方法调用调用remote" class="header-anchor">#</a> 发送方法调用调用Remote</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcDispatcher</span> <span class="token keyword">extends</span> <span class="token class-name">MessageDispatcher</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RspList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">callRemoteMethods</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> dests<span class="token punctuation">,</span> <span class="token class-name">MethodCall</span> method_call<span class="token punctuation">,</span>
                                            <span class="token class-name">RequestOptions</span> opts<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dests <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> dests<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// don't send if dest list is empty</span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;destination list of %s() is empty: no need to send message&quot;</span><span class="token punctuation">,</span> method_call<span class="token punctuation">.</span><span class="token function">methodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> empty_rsplist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Buffer</span> buf<span class="token operator">=</span><span class="token function">methodCallToBuffer</span><span class="token punctuation">(</span>method_call<span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RspList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> retval<span class="token operator">=</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">castMessage</span><span class="token punctuation">(</span>dests<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;dests=%s, method_call=%s, options=%s, responses: %s&quot;</span><span class="token punctuation">,</span> dests<span class="token punctuation">,</span> method_call<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Buffer</span> <span class="token function">methodCallToBuffer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MethodCall</span> call<span class="token punctuation">,</span> <span class="token class-name">Marshaller</span> marshaller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token operator">=</span>call<span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> estimated_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> arg<span class="token operator">:</span> args<span class="token punctuation">)</span>
                estimated_size<span class="token operator">+=</span>marshaller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">?</span> marshaller<span class="token punctuation">.</span><span class="token function">estimatedSize</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteArrayDataOutputStream</span> out<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayDataOutputStream</span><span class="token punctuation">(</span>estimated_size<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        call<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> out<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，这里有一个优化点是，默认的方法参数创建时只会根据参数数量做大致估计（50），但如果我们引入一个具体的marshaller，就会根据我们自定义的估算方法将参数大小做进一步的估计。因为如果estimated_size和参数大小的差距过大，在OutputStream中进行write操作时，会有扩容操作，也就是byte数组的copy操作。这个操作次数会影响到性能和内存占用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodCall</span> <span class="token keyword">implements</span> <span class="token class-name">Streamable</span><span class="token punctuation">,</span> <span class="token class-name">Constructable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodCall</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeTo</span><span class="token punctuation">(</span><span class="token class-name">DataOutput</span> out<span class="token punctuation">,</span> <span class="token class-name">Marshaller</span> marshaller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">METHOD</span><span class="token operator">:</span>
                <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>method_name<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">writeMethod</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPES</span><span class="token operator">:</span>
                <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>method_name<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">writeTypes</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">ID</span><span class="token operator">:</span>
                out<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span>method_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;mode &quot;</span> <span class="token operator">+</span> mode <span class="token operator">+</span> <span class="token string">&quot; unknown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">writeArgs</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeArgs</span><span class="token punctuation">(</span><span class="token class-name">DataOutput</span> out<span class="token punctuation">,</span> <span class="token class-name">Marshaller</span> marshaller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> args_len<span class="token operator">=</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">?</span> args<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>args_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>args_len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>marshaller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                marshaller<span class="token punctuation">.</span><span class="token function">objectToStream</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">objectToStream</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出当有Marshaller存在时，会使用自己定义的序列化方式。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Marshaller</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">estimatedSize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> arg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">objectToStream</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">DataOutput</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> <span class="token function">objectFromStream</span><span class="token punctuation">(</span><span class="token class-name">DataInput</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="remote远端接收方法调用请求"><a href="#remote远端接收方法调用请求" class="header-anchor">#</a> Remote远端接收方法调用请求</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcDispatcher</span> <span class="token keyword">extends</span> <span class="token class-name">MessageDispatcher</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Message</span> req<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>server_obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;NoMethodHandlerIsRegisteredDiscardingRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>req <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> req<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;MessageOrMessageBufferIsNull&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">MethodCall</span> method_call<span class="token operator">=</span><span class="token function">methodCallFromBuffer</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getRawBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;[sender=%s], method_call: %s&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method_call<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>method_call<span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MethodCall</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>method_invoker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// this trumps a method lookup</span>
                <span class="token keyword">return</span> method_invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>server_obj<span class="token punctuation">,</span> method_call<span class="token punctuation">.</span><span class="token function">methodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method_call<span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>method_lookup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;MethodCall uses ID=%d, but method_lookup has not been set&quot;</span><span class="token punctuation">,</span> method_call<span class="token punctuation">.</span><span class="token function">methodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Method</span> m<span class="token operator">=</span>method_lookup<span class="token punctuation">.</span><span class="token function">findMethod</span><span class="token punctuation">(</span>method_call<span class="token punctuation">.</span><span class="token function">methodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;no method found for &quot;</span> <span class="token operator">+</span> method_call<span class="token punctuation">.</span><span class="token function">methodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            method_call<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> method_call<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>server_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">MethodCall</span> <span class="token function">methodCallFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token class-name">Marshaller</span>   marshaller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteArrayDataInputStream</span> in<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayDataInputStream</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodCall</span> call<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MethodCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        call<span class="token punctuation">.</span><span class="token function">readFrom</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> call<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodCall</span> <span class="token keyword">implements</span> <span class="token class-name">Streamable</span><span class="token punctuation">,</span> <span class="token class-name">Constructable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodCall</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readFrom</span><span class="token punctuation">(</span><span class="token class-name">DataInput</span> in<span class="token punctuation">,</span> <span class="token class-name">Marshaller</span> marshaller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>mode<span class="token operator">=</span>in<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">METHOD</span><span class="token operator">:</span>
                method_name<span class="token operator">=</span><span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">readMethod</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPES</span><span class="token operator">:</span>
                method_name<span class="token operator">=</span><span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">readTypes</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">ID</span><span class="token operator">:</span>
                method_id<span class="token operator">=</span>in<span class="token punctuation">.</span><span class="token function">readShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;mode &quot;</span> <span class="token operator">+</span> mode <span class="token operator">+</span> <span class="token string">&quot; unknown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">readArgs</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> marshaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">readArgs</span><span class="token punctuation">(</span><span class="token class-name">DataInput</span> in<span class="token punctuation">,</span> <span class="token class-name">Marshaller</span> marshaller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> args_len<span class="token operator">=</span>in<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>args_len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        args<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>args_len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>marshaller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">?</span> marshaller<span class="token punctuation">.</span><span class="token function">objectFromStream</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">objectFromStream</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;target is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> cl<span class="token operator">=</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> meth<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">METHOD</span><span class="token operator">:</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    meth<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPES</span><span class="token operator">:</span>
                meth<span class="token operator">=</span><span class="token function">getMethod</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> method_name<span class="token punctuation">,</span> types<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">ID</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;mode &quot;</span> <span class="token operator">+</span> mode <span class="token operator">+</span> <span class="token string">&quot; is invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>meth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// allow method invocation on protected or (package-) private methods, too</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>meth<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    meth<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> meth<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> target_ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Throwable</span> exception<span class="token operator">=</span>target_ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span>exception<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span>exception<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">Exception</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>exception<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">(</span>method_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实也就是一个简单的反射。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/jgroups/Building Blocks使用.html" class="prev">
        Building Blocks使用
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bdbeba68.js" defer></script><script src="/assets/js/2.327ce0e8.js" defer></script><script src="/assets/js/39.37c8c86a.js" defer></script>
  </body>
</html>
